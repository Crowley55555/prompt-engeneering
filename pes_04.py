"""
–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–ø–∏—Å–∞–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º —á–µ—Ä–µ–∑ Langfuse

–ù–ê–°–¢–†–û–ô–ö–ê:
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: pip install -r requirements.txt
2. –°–æ–∑–¥–∞–π—Ç–µ .env —Ñ–∞–π–ª —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏:
   OPENAI_API_KEY=–≤–∞—à_–∫–ª—é—á_openai
   LANGFUSE_PUBLIC_KEY=–≤–∞—à_–ø—É–±–ª–∏—á–Ω—ã–π_–∫–ª—é—á_langfuse
   LANGFUSE_SECRET_KEY=–≤–∞—à_—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–∫–ª—é—á_langfuse
   LANGFUSE_HOST=https://cloud.langfuse.com (–∏–ª–∏ –≤–∞—à —Ö–æ—Å—Ç)

3. –ü–æ–ª—É—á–∏—Ç–µ –∫–ª—é—á–∏ Langfuse:
   - –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ https://cloud.langfuse.com
   - –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ Public Key –∏ Secret Key –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–æ–µ–∫—Ç–∞

–ú–û–ù–ò–¢–û–†–ò–ù–ì:
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ OpenAI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è –≤ Langfuse
- –ú–æ–∂–Ω–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏, –º–µ—Ç—Ä–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–ª—é—á–µ–π Langfuse –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
"""

import time  # –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è time –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—Ä–µ–º–µ–Ω–µ–º –∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
import openai  # –ò–º–ø–æ—Ä—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ OpenAI –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å API

from openai import OpenAI  # –ò–º–ø–æ—Ä—Ç –∫–ª–∞—Å—Å–∞ OpenAI –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ API
from langchain_core.prompts import ChatPromptTemplate  # –ò–º–ø–æ—Ä—Ç –∫–ª–∞—Å—Å–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —à–∞–±–ª–æ–Ω–∞–º–∏ —á–∞—Ç-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ LangChain
from langchain_openai import ChatOpenAI  # –ò–º–ø–æ—Ä—Ç –∫–ª–∞—Å—Å–∞ ChatOpenAI –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Ç-–º–æ–¥–µ–ª—å—é OpenAI —á–µ—Ä–µ–∑ LangChain

import requests  # –ò–º–ø–æ—Ä—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ requests –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤
import json  # –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è json –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JSON-–¥–∞–Ω–Ω—ã–º–∏
from dotenv import load_dotenv
import os

# –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ Langfuse
from langfuse import Langfuse
from langfuse.langchain import CallbackHandler

load_dotenv()

api_key = os.getenv("OPENAI_API_KEY")

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Langfuse
langfuse_public_key = os.getenv("LANGFUSE_PUBLIC_KEY")
langfuse_secret_key = os.getenv("LANGFUSE_SECRET_KEY")
langfuse_host = os.getenv("LANGFUSE_HOST", "https://cloud.langfuse.com")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Langfuse
langfuse = Langfuse(
    public_key=langfuse_public_key,
    secret_key=langfuse_secret_key,
    host=langfuse_host
)
url = "https://api.openai.com/v1/chat/completions"  # URL —ç–Ω–¥–ø–æ–π–Ω—Ç–∞ OpenAI API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç-–∫–æ–º–ø–ª–∏—Ç–æ–≤

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ LangChain
def conversation(user_input):
  # –°–æ–∑–¥–∞–Ω–∏–µ CallbackHandler –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ Langfuse
  langfuse_handler = CallbackHandler()
  
  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ ChatOpenAI —Å –∑–∞–¥–∞–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º –º–æ–¥–µ–ª–∏ –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–æ–π (–∫–æ–Ω—Ç—Ä–æ–ª—å –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏)
  llm = ChatOpenAI(
        model="gpt-4o-mini",
        temperature=0.2,
        api_key=api_key  # –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    )

  # –°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π user_input, –∑–∞–¥–∞—é—â–µ–≥–æ —Ä–æ–ª—å –º–æ–¥–µ–ª–∏ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã SEO-–∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
  prompt = ChatPromptTemplate.from_messages([
      ("system", """–°–æ—Å—Ç–∞–≤—å SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ç–æ–≤–∞—Ä–∞, —Å–ª–µ–¥—É—è –ø–æ—à–∞–≥–æ–≤–æ–º—É —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—é:

–®–∞–≥ 1: –û–ø—Ä–µ–¥–µ–ª–∏ —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞.
–®–∞–≥ 2: –ü–µ—Ä–µ—á–∏—Å–ª–∏ 3‚Äì4 –∫–ª—é—á–µ–≤—ã—Ö –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞.
–®–∞–≥ 3: –í–∫–ª—é—á–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: ¬´–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞¬ª, ¬´Keychron K8 Pro¬ª, ¬´RGB –ø–æ–¥—Å–≤–µ—Ç–∫–∞¬ª, ¬´–¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–≤ –∏ –≥–µ–π–º–µ—Ä–æ–≤¬ª ‚Äî —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–∏ –∑–≤—É—á–∞–ª–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ.
–®–∞–≥ 4: –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é.
–®–∞–≥ 5: –û–±—ä–µ–¥–∏–Ω–∏ –≤—Å—ë –≤ —Å–≤—è–∑–Ω—ã–π —Ç–µ–∫—Å—Ç –æ–±—ä—ë–º–æ–º 150‚Äì200 —Å–ª–æ–≤.

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –¥–æ 500 —Å–ª–æ–≤.
–ü—Ä–æ–≤–µ—Ä—å —Ç–µ–∫—Å—Ç –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π –∏ –ø–æ–≤—Ç–æ—Ä–æ–≤.

–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:
üîπ **–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:**
[–∫—Ä–∞—Ç–∫–æ–µ –∏ —ë–º–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å –£–¢–ü]

üîπ **–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è):**
[–æ–¥–Ω–æ —Å–∏–ª—å–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ, –º–æ—Ç–∏–≤–∏—Ä—É—é—â–µ–µ –∫—É–ø–∏—Ç—å]

üîπ **–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (5‚Äì7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π):**
[–æ–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π, —É–¥–æ–±—Å—Ç–≤–∞, –≤—ã–≥–æ–¥—ã –∏ —Å—Ü–µ–Ω–∞—Ä–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è; –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è]

üîπ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- [–ø—É–Ω–∫—Ç 1]
- [–ø—É–Ω–∫—Ç 2]
- [–ø—É–Ω–∫—Ç 3]
- [–ø—É–Ω–∫—Ç 4]

üîπ **–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- [–ø–∞—Ä–∞–º–µ—Ç—Ä: –∑–Ω–∞—á–µ–Ω–∏–µ]
- [–ø–∞—Ä–∞–º–µ—Ç—Ä: –∑–Ω–∞—á–µ–Ω–∏–µ]
- [–ø–∞—Ä–∞–º–µ—Ç—Ä: –∑–Ω–∞—á–µ–Ω–∏–µ]
- [–ø–∞—Ä–∞–º–µ—Ç—Ä: –∑–Ω–∞—á–µ–Ω–∏–µ]

üîπ **SEO-–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:**
[—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é]"""),
      ("user", "–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_input}")
  ])

  # –°–æ–∑–¥–∞–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ (chain) - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ |
  chain = prompt | llm

  # –í—ã–∑–æ–≤ —Ü–µ–ø–æ—á–∫–∏ —Å –ø–µ—Ä–µ–¥–∞—á–µ–π user_input –∏ callback handler –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  response = chain.invoke(
      {"user_input": user_input}, 
      config={"callbacks": [langfuse_handler]}
  )

  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  return response.content

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Langfuse
def test_langfuse_connection():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Langfuse –∑–∞–ø—É—Å–∫–æ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ LLM —Å CallbackHandler."""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        if not langfuse_public_key or not langfuse_secret_key:
            print("‚ö†Ô∏è  –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Langfuse –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!")
            print("–î–æ–±–∞–≤—å—Ç–µ –≤ .env —Ñ–∞–π–ª:")
            print("LANGFUSE_PUBLIC_KEY=–≤–∞—à_–ø—É–±–ª–∏—á–Ω—ã–π_–∫–ª—é—á")
            print("LANGFUSE_SECRET_KEY=–≤–∞—à_—Å–µ–∫—Ä–µ—Ç–Ω—ã–π_–∫–ª—é—á")
            print("LANGFUSE_HOST=https://cloud.langfuse.com")
            return False

        # –°–æ–∑–¥–∞–µ–º CallbackHandler –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ –º–æ–¥–µ–ª–∏
        handler = CallbackHandler()

        test_llm = ChatOpenAI(
            model="gpt-4o-mini",
            temperature=0.0,
            api_key=api_key
        )

        # –ö–æ—Ä–æ—Ç–∫–∏–π –ø–∏–Ω–≥-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ —Å–æ–±—ã—Ç–∏—è –¥–æ—Ö–æ–¥—è—Ç –¥–æ Langfuse
        _ = test_llm.invoke("ping", config={"callbacks": [handler]})

        # –Ø–≤–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π SDK
        try:
            langfuse.flush()
        except Exception:
            # –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö Python SDK flush –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å ‚Äî —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
            pass

        print("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Langfuse —É—Å–ø–µ—à–Ω–æ!")
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Langfuse: {e}")
        return False

# –ü—Ä–∏–º–µ—Ä –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–∏ conversation —Å –∑–∞–ø—Ä–æ—Å–æ–º –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
if __name__ == "__main__":
    print("üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º —á–µ—Ä–µ–∑ Langfuse")
    print("="*60)
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Langfuse
    if test_langfuse_connection():
        print("üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–µ–Ω - –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å—Å—è –≤ Langfuse")
    else:
        print("‚ö†Ô∏è  –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–∫–ª—é—á–µ–Ω - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è")
    
    print("="*60)
    
    try:
        text = input("–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞: ")
        print("\nüîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...")
        
        result = conversation(text)
        
        print("\n" + "="*50)
        print("üìù –†–µ–∑—É–ª—å—Ç–∞—Ç:")
        print(result)
        print("="*50)
        
        if langfuse_public_key and langfuse_secret_key:
            print("üìä –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Langfuse –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        print("–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–æ —Å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é OpenAI API –≤ –≤–∞—à–µ–º —Ä–µ–≥–∏–æ–Ω–µ.")